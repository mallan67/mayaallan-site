name: Rotate DB & Admin Passwords (with artifact)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  rotate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install packages
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq openssl python3-pip
          python3 -m pip install --user bcrypt
          export PATH="$HOME/.local/bin:$PATH"

      - name: Generate new passwords (private)
        id: gen
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%dT%H%M%SZ")
          NEW_DB_PASS=$(openssl rand -base64 32)
          NEW_ADMIN_PASS=$(openssl rand -base64 20)
          echo "TS=${TS}" >> "$GITHUB_ENV"
          echo "NEW_DB_PASS<<EOF" >> "$GITHUB_OUTPUT"
          echo "${NEW_DB_PASS}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "NEW_ADMIN_PASS<<EOF" >> "$GITHUB_OUTPUT"
          echo "${NEW_ADMIN_PASS}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Rotate DB user password
        env:
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
          DB_USER: ${{ secrets.DB_USER }}
        run: |
          set -euo pipefail
          NEW_DB_PASS="${{ steps.gen.outputs.NEW_DB_PASS }}"
          if [ -z "${DB_ADMIN_URL:-}" ]; then
            echo "DB_ADMIN_URL secret is required."
            exit 1
          fi
          psql "$DB_ADMIN_URL" -v ON_ERROR_STOP=1 -q -c "ALTER USER \"${DB_USER}\" WITH PASSWORD '$NEW_DB_PASS';"

      - name: Rotate admin password (bcrypt + DB update)
        env:
          DB_ADMIN_URL: ${{ secrets.DB_ADMIN_URL }}
        run: |
          set -euo pipefail
          NEW_ADMIN_PASS="${{ steps.gen.outputs.NEW_ADMIN_PASS }}"
          HASH=$(python3 - <<'PY'
import bcrypt,sys
pw=sys.argv[1].encode()
print(bcrypt.hashpw(pw,bcrypt.gensalt(10)).decode())
PY
 "${NEW_ADMIN_PASS}")
          psql "$DB_ADMIN_URL" -v ON_ERROR_STOP=1 -q -c "UPDATE public.admin_user SET password_hash = '${HASH}' WHERE email = 'maya@mayaallan.com';"

      - name: Update Vercel DATABASE_URL (optional)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
        run: |
          set -euo pipefail
          NEW_DB_PASS="${{ steps.gen.outputs.NEW_DB_PASS }}"
          if [ -z "${VERCEL_TOKEN:-}" ] || [ -z "${VERCEL_PROJECT_ID:-}" ]; then
            echo "VERCEL_TOKEN or VERCEL_PROJECT_ID not set; skipping Vercel update."
            exit 0
          fi
          DB_PORT="${DB_PORT:-5432}"
          NEW_DB_URL="postgres://${DB_USER}:${NEW_DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=require"

          EXISTING_ID=$(curl -s -H "Authorization: Bearer ${VERCEL_TOKEN}" "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env?limit=100" \
            | jq -r --arg K "DATABASE_URL" '.env[]? | select(.key==$K) | .id' || true)

          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
            curl -s -X PATCH "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env/${EXISTING_ID}" \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"value\":\"${NEW_DB_URL}\"}" | jq -r .
          else
            curl -s -X POST "https://api.vercel.com/v9/projects/${VERCEL_PROJECT_ID}/env" \
              -H "Authorization: Bearer ${VERCEL_TOKEN}" \
              -H "Content-Type: application/json" \
              -d "{\"key\":\"DATABASE_URL\",\"value\":\"${NEW_DB_URL}\",\"target\":[\"production\"],\"type\":\"encrypted\"}" | jq -r .
          fi

      - name: Produce rotation result artifact
        run: |
          TS="${{ env.TS:-$(date -u +"%Y%m%dT%H%M%SZ") }}"
          NEW_DB_PASS="${{ steps.gen.outputs.NEW_DB_PASS }}"
          NEW_ADMIN_PASS="${{ steps.gen.outputs.NEW_ADMIN_PASS }}"
          echo "Rotation timestamp: ${TS}" > rotation_result.txt
          echo "DB_USER: ${{ secrets.DB_USER }}" >> rotation_result.txt
          echo "NEW_DB_PASSWORD: ${NEW_DB_PASS}" >> rotation_result.txt
          echo "NEW_ADMIN_PASSWORD: ${NEW_ADMIN_PASS}" >> rotation_result.txt
          ls -l rotation_result.txt || true

      - name: Upload rotation artifact (contains the new passwords)
        uses: actions/upload-artifact@v4
        with:
          name: rotation-result-${{ env.TS }}
          path: rotation_result.txt
